# -*- coding: utf-8 -*-
"""
通用NLP信息提取模块（飞书风格强化版）
"""
from typing import List, Dict, Any
import json
import os
import requests

# 嵌入你的通义千问API Key
FIXED_API_KEY = "sk-ecb46034c430477e9c9a4b4fd6589742"

def get_llm_response(prompt: str, api_key: str = FIXED_API_KEY) -> str:
    """调用通义千问API（适配新版返回结构）"""
    url = "https://dashscope.aliyuncs.com/api/v1/services/aigc/text-generation/generation"
    headers = {
        "Authorization": f"Bearer {api_key}",
        "Content-Type": "application/json"
    }
    data = {
        "model": "qwen-turbo",
        "input": {"messages": [{"role": "user", "content": prompt}]},
        "parameters": {"temperature": 0.1, "result_format": "text", "max_tokens": 3000}
    }
    try:
        response = requests.post(url, headers=headers, json=data, timeout=30)
        response.raise_for_status()
        result = response.json()
        return result["output"]["text"]
    except Exception as e:
        return json.dumps({"error": f"大模型调用失败：{str(e)}"}, ensure_ascii=False)

def extract_meeting_info(speech_list: List[Dict[str, Any]], template_type: str) -> Dict[str, Any]:
    """智能提取会议信息（飞书风格强化版）"""
    # 1. 拼接会议文本
    meeting_text = "\n".join([f"{item['time']} {item['speaker']}：{item['content']}" for item in speech_list])
    
    # 2. 飞书风格提示词（完全复刻飞书智能纪要）
    prompt_templates = {
        "通用商务会议": f"""
        请严格按照飞书智能会议纪要的格式和风格，分析以下会议文本，输出JSON格式内容，仅返回JSON，无任何多余解释：
        {{
            "会议核心信息": {{
                "主题": "会议核心主题",
                "参与人": "参会人员（分角色）",
                "会议时间": "会议时间",
                "核心议题": "核心讨论议题"
            }},
            "章节时间线": [
                {{"时间区间": "00:00:00-00:10:00", "章节主题": "章节核心内容", "关键发言": "核心发言摘要"}},
                {{"时间区间": "00:10:00-00:20:00", "章节主题": "章节核心内容", "关键发言": "核心发言摘要"}}
            ],
            "核心标签": {{
                "决策共识": "会议达成的核心决策（1-2句）",
                "核心逻辑": "会议讨论的核心逻辑/商业逻辑",
                "避雷提醒": "需要规避的风险/注意事项",
                "机遇窗口": "潜在的机会/优势/窗口期"
            }},
            "双方资源/诉求": "合作双方的核心资源、需求、合作意向（分点说明）",
            "合作模式/规划": {{
                "短期规划（0-3个月）": "具体动作/里程碑",
                "中长期规划（4-12个月）": "具体动作/里程碑"
            }},
            "核心结论与共识": "详细的决策共识（分点）",
            "待办事项与责任人": [
                {{"事项": "具体待办", "责任人": "姓名/角色", "截止时间": "时间", "优先级": "高/中/低"}},
                {{"事项": "具体待办", "责任人": "姓名/角色", "截止时间": "时间", "优先级": "高/中/低"}}
            ],
            "问题与风险点": "待解决问题/项目风险（分点）",
            "下次会议安排": "下次会议时间/议题/参与人"
        }}
        会议文本：{meeting_text}
        """,
        "项目同步会议": f"""
        请严格按照飞书智能会议纪要的格式和风格，分析以下会议文本，输出JSON格式内容，仅返回JSON，无任何多余解释：
        {{
            "会议核心信息": {{
                "主题": "会议核心主题",
                "参与人": "参会人员（分角色）",
                "会议时间": "会议时间",
                "核心议题": "核心讨论议题"
            }},
            "章节时间线": [
                {{"时间区间": "00:00:00-00:10:00", "章节主题": "章节核心内容", "关键发言": "核心发言摘要"}}
            ],
            "核心标签": {{
                "决策共识": "会议达成的核心决策",
                "核心逻辑": "项目推进的核心逻辑",
                "避雷提醒": "项目风险/避坑点",
                "机遇窗口": "项目优化机会"
            }},
            "项目当前进度": {{
                "已完成项": ["完成的模块/任务"],
                "未完成项": ["未完成的模块/任务", "延期原因"],
                "完成率": "整体完成率"
            }},
            "资源需求与协调": ["技术/人力/物料需求", "跨部门协调事项"],
            "后续执行计划": {{
                "短期（1周内）": "具体动作",
                "中期（1个月内）": "具体动作"
            }},
            "核心结论与共识": "详细的决策共识（分点）",
            "待办事项与责任人": [
                {{"事项": "具体待办", "责任人": "姓名/角色", "截止时间": "时间", "优先级": "高/中/低"}}
            ],
            "问题与风险点": ["项目风险1", "项目风险2"],
            "下次会议安排": "下次会议时间/议题/参与人"
        }}
        会议文本：{meeting_text}
        """,
        "需求评审会议": f"""
        请严格按照飞书智能会议纪要的格式和风格，分析以下会议文本，输出JSON格式内容，仅返回JSON，无任何多余解释：
        {{
            "会议核心信息": {{
                "主题": "会议核心主题",
                "参与人": "参会人员（分角色）",
                "会议时间": "会议时间",
                "核心议题": "核心讨论议题"
            }},
            "章节时间线": [
                {{"时间区间": "00:00:00-00:10:00", "章节主题": "章节核心内容", "关键发言": "核心发言摘要"}}
            ],
            "核心标签": {{
                "决策共识": "会议达成的核心决策",
                "核心逻辑": "需求设计的核心逻辑",
                "避雷提醒": "需求落地风险/避坑点",
                "机遇窗口": "需求优化机会"
            }},
            "需求核心内容": {{
                "需求背景": "需求提出的背景",
                "核心目标": "需求要解决的问题",
                "功能范围": ["核心功能1", "核心功能2"]
            }},
            "评审意见与结论": {{
                "通过项": ["无异议的需求点"],
                "修改项": ["需要修改的需求点+修改建议"],
                "驳回项": ["驳回的需求点+原因"]
            }},
            "需求修改要求": ["修改标准", "提交流程", "验收条件"],
            "核心结论与共识": "详细的决策共识（分点）",
            "待办事项与责任人": [
                {{"事项": "具体待办", "责任人": "姓名/角色", "截止时间": "时间", "优先级": "高/中/低"}}
            ],
            "问题与风险点": ["需求落地风险1", "风险2"],
            "下次会议安排": "下次会议时间/议题/参与人"
        }}
        会议文本：{meeting_text}
        """,
        "周度例会": f"""
        请严格按照飞书智能会议纪要的格式和风格，分析以下会议文本，输出JSON格式内容，仅返回JSON，无任何多余解释：
        {{
            "会议核心信息": {{
                "主题": "会议核心主题",
                "参与人": "参会人员（分角色）",
                "会议时间": "会议时间",
                "核心议题": "核心讨论议题"
            }},
            "章节时间线": [
                {{"时间区间": "00:00:00-00:10:00", "章节主题": "章节核心内容", "关键发言": "核心发言摘要"}}
            ],
            "核心标签": {{
                "决策共识": "会议达成的核心决策",
                "核心逻辑": "工作推进的核心逻辑",
                "避雷提醒": "工作风险/避坑点",
                "机遇窗口": "工作优化机会"
            }},
            "本周工作完成情况": {{
                "完成项": ["张三：XX任务（100%）", "李四：XX任务（80%）"],
                "未完成项": ["王五：XX任务（50%）- 原因：XX"]
            }},
            "下周工作计划": [
                {{"岗位": "张三", "核心任务": "XX任务", "优先级": "高", "预期完成率": "100%"}},
                {{"岗位": "李四", "核心任务": "XX任务", "优先级": "中", "预期完成率": "100%"}}
            ],
            "工作难点与协助需求": ["张三：需要XX部门协助XX事项", "李四：XX问题需要解决"],
            "核心结论与共识": "详细的决策共识（分点）",
            "待办事项与责任人": [
                {{"事项": "具体待办", "责任人": "姓名/角色", "截止时间": "时间", "优先级": "高/中/低"}}
            ],
            "问题与风险点": ["工作风险1", "风险2"],
            "下次会议安排": "下次会议时间/议题/参与人"
        }}
        会议文本：{meeting_text}
        """
    }
    
    # 3. 调用大模型
    prompt = prompt_templates[template_type]
    llm_result = get_llm_response(prompt)
    
    # 4. 解析结果
    try:
        return json.loads(llm_result)
    except:
        # 降级返回模拟数据
        return {
            "error": "大模型返回格式异常，使用飞书风格模拟数据",
            "会议核心信息": {
                "主题": f"{template_type} - 核心事项讨论",
                "参与人": "未知",
                "会议时间": "未知",
                "核心议题": "未知"
            },
            "章节时间线": [{"时间区间": "00:00:00-00:10:00", "章节主题": "会议开场", "关键发言": "无"}],
            "核心标签": {
                "决策共识": "品牌化是核心，速度决定成败",
                "核心逻辑": "资源互补，合作共赢",
                "避雷提醒": "避免过早扩张，聚焦核心目标",
                "机遇窗口": "市场空白期，抢占先机"
            },
            "核心结论与共识": "请检查会议文本是否完整",
            "待办事项与责任人": [{"事项": "测试待办", "责任人": "测试用户", "截止时间": "2026-02-28", "优先级": "高"}],
            "问题与风险点": ["无"],
            "下次会议安排": "无"
        }

# 测试
if __name__ == '__main__':
    test_speech = [{"time": "00:00:00", "speaker": "主持人", "content": "本次会议讨论XX项目进度，开发完成80%，下周联调"}]
    print(extract_meeting_info(test_speech, "项目同步会议"))
